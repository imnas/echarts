{"version":3,"sources":["../../../src/lib/series/OHLCSeries.js"],"names":["OHLCSeries","props","renderSVG","bind","drawOnCanvas","ctx","moreProps","yAccessor","xAccessor","xScale","yScale","chartConfig","plotData","barData","getOHLCBars","clip","className","strokeWidth","bars","map","d","idx","stroke","openX1","openY","openX2","x","y1","y2","closeX1","closeY","closeX2","propTypes","string","classNames","oneOfType","func","isRequired","bool","defaultProps","open","high","low","close","absoluteChange","wickNest","key","entries","lineWidth","forEach","outer","values","strokeStyle","beginPath","moveTo","lineTo","classNamesProp","strokeProp","strokeFunc","classNameFunc","width","length","barWidth","Math","max","round","min","filter","ohlc"],"mappings":"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","file":"OHLCSeries.js","sourcesContent":["\"use strict\";\n\nimport { nest } from \"d3-collection\";\nimport React, { Component } from \"react\";\nimport PropTypes from \"prop-types\";\nimport GenericChartComponent from \"../GenericChartComponent\";\nimport { getAxisCanvas } from \"../GenericComponent\";\n\nimport { isDefined, functor } from \"../utils\";\n\nclass OHLCSeries extends Component {\n\tconstructor(props) {\n\t\tsuper(props);\n\t\tthis.renderSVG = this.renderSVG.bind(this);\n\t\tthis.drawOnCanvas = this.drawOnCanvas.bind(this);\n\t}\n\tdrawOnCanvas(ctx, moreProps) {\n\t\tconst { yAccessor } = this.props;\n\t\tconst { xAccessor } = moreProps;\n\t\tconst { xScale, chartConfig: { yScale }, plotData } = moreProps;\n\n\t\tconst barData = getOHLCBars(this.props, xAccessor, yAccessor, xScale, yScale, plotData);\n\t\tdrawOnCanvas(ctx, barData);\n\t}\n\trender() {\n\t\tconst { clip } = this.props;\n\n\t\treturn <GenericChartComponent\n\t\t\tsvgDraw={this.renderSVG}\n\t\t\tcanvasToDraw={getAxisCanvas}\n\t\t\tcanvasDraw={this.drawOnCanvas}\n\t\t\tclip={clip}\n\t\t\tdrawOn={[\"pan\"]}\n\t\t/>;\n\t}\n\trenderSVG(moreProps) {\n\t\tconst { className, yAccessor } = this.props;\n\t\tconst { xAccessor } = moreProps;\n\t\tconst { xScale, chartConfig: { yScale }, plotData } = moreProps;\n\n\n\t\tconst barData = getOHLCBars(this.props, xAccessor, yAccessor, xScale, yScale, plotData);\n\n\t\tconst { strokeWidth, bars } = barData;\n\n\t\treturn <g className={className}>\n\t\t\t{bars.map((d, idx) => <path key={idx}\n\t\t\t\tclassName={d.className} stroke={d.stroke} strokeWidth={strokeWidth}\n\t\t\t\td={`M${d.openX1} ${d.openY} L${d.openX2} ${d.openY} M${d.x} ${d.y1} L${d.x} ${d.y2} M${d.closeX1} ${d.closeY} L${d.closeX2} ${d.closeY}`}/>)}\n\t\t</g>;\n\t}\n}\n\nOHLCSeries.propTypes = {\n\tclassName: PropTypes.string,\n\tclassNames: PropTypes.oneOfType([\n\t\tPropTypes.func,\n\t\tPropTypes.string\n\t]).isRequired,\n\tstroke: PropTypes.oneOfType([\n\t\tPropTypes.func,\n\t\tPropTypes.string\n\t]).isRequired,\n\tyAccessor: PropTypes.func.isRequired,\n\tclip: PropTypes.bool.isRequired,\n};\n\nOHLCSeries.defaultProps = {\n\tclassName: \"react-stockcharts-ohlc\",\n\tyAccessor: (d) => ({ open: d.open, high: d.high, low: d.low, close: d.close }),\n\tclassNames: d => isDefined(d.absoluteChange) ? (d.absoluteChange > 0 ? \"up\" : \"down\") : \"firstbar\",\n\tstroke: d => isDefined(d.absoluteChange) ? (d.absoluteChange > 0 ? \"#6BA583\" : \"#FF0000\") : \"#000000\",\n\tclip: true,\n};\n\nfunction drawOnCanvas(ctx, barData) {\n\n\tconst { strokeWidth, bars } = barData;\n\n\tconst wickNest = nest()\n\t\t.key(d => d.stroke)\n\t\t.entries(bars);\n\n\tctx.lineWidth = strokeWidth;\n\n\twickNest.forEach(outer => {\n\t\tconst { key, values } = outer;\n\t\tctx.strokeStyle = key;\n\t\tvalues.forEach(d => {\n\t\t\tctx.beginPath();\n\t\t\tctx.moveTo(d.x, d.y1);\n\t\t\tctx.lineTo(d.x, d.y2);\n\n\t\t\tctx.moveTo(d.openX1, d.openY);\n\t\t\tctx.lineTo(d.openX2, d.openY);\n\n\t\t\tctx.moveTo(d.closeX1, d.closeY);\n\t\t\tctx.lineTo(d.closeX2, d.closeY);\n\n\t\t\tctx.stroke();\n\t\t});\n\t});\n}\n\nfunction getOHLCBars(props, xAccessor, yAccessor, xScale, yScale, plotData) {\n\tconst { classNames: classNamesProp, stroke: strokeProp } = props;\n\n\tconst strokeFunc = functor(strokeProp);\n\tconst classNameFunc = functor(classNamesProp);\n\n\tconst width = xScale(xAccessor(plotData[plotData.length - 1]))\n\t\t- xScale(xAccessor(plotData[0]));\n\n\tconst barWidth = Math.max(1, Math.round(width / (plotData.length - 1) / 2) - 1.5);\n\tconst strokeWidth = Math.min(barWidth, 6);\n\n\tconst bars = plotData\n\t\t.filter(d => isDefined(yAccessor(d).close))\n\t\t.map(d => {\n\t\t\tconst ohlc = yAccessor(d),\n\t\t\t\tx = Math.round(xScale(xAccessor(d))),\n\t\t\t\ty1 = yScale(ohlc.high),\n\t\t\t\ty2 = yScale(ohlc.low),\n\t\t\t\topenX1 = x - barWidth,\n\t\t\t\topenX2 = x + strokeWidth / 2,\n\t\t\t\topenY = yScale(ohlc.open),\n\t\t\t\tcloseX1 = x - strokeWidth / 2,\n\t\t\t\tcloseX2 = x + barWidth,\n\t\t\t\tcloseY = yScale(ohlc.close),\n\t\t\t\tclassName = classNameFunc(d),\n\t\t\t\tstroke = strokeFunc(d);\n\n\t\t\treturn { x, y1, y2, openX1, openX2, openY, closeX1, closeX2, closeY, stroke, className };\n\t\t});\n\treturn { barWidth, strokeWidth, bars };\n}\n\nexport default OHLCSeries;\n"]}